---
/**
 * HeroHomepage
 *
 * KB RATING: A (~1KB JS for events toggle + auto-advance)
 * CARBON TIER: A (event images lazy loaded on demand)
 *
 * Full-viewport hero with background image and text overlay.
 * "Upcoming Events" toggle reveals event posters edge-to-edge â€”
 * no overlays, no shadows, just the images.
 *
 * Desktop: 3 posters at 4:5 = 12:5 hero ratio. Auto-advances if >3.
 * Mobile: 1 poster at 4:5. Auto-advances if >1.
 * Repeats posters to always fill 3 desktop columns.
 *
 * ============================================================
 * ðŸš€ NEW CLIENT SETUP â€” follow these steps:
 * ============================================================
 *
 * STEP 1: Set position
 *   Options: "bottom-left" | "left" | "center" | "right" | "bottom-right"
 *
 * STEP 2: Set overlay darkness
 *   Change to your chosen opacity (0-100).
 *
 * STEP 3: Set container width
 *   Options: "full" (text aligns with nav) | "contained" (1200px)
 *
 * ============================================================
 * ðŸ“ PRISMIC FIELDS (client controls in CMS)
 * ============================================================
 *   - heading (Key Text) â€” main H1 text
 *   - tagline (Key Text) â€” supporting text
 *   - image (Image) â€” background image
 *   - logo (Image) â€” optional centered logo overlay
 *   - button_label (Key Text) â€” button text
 *   - button_link (Link) â€” button destination
 *
 * Events auto-fetched from Prismic "event" type. No extra fields needed.
 * ============================================================
 */
import { client, linkResolver } from "../../lib/prismic";
import * as prismic from "@prismicio/client";

interface Props {
  heading: string;
  tagline?: string;
  image?: {
    url?: string;
    alt?: string;
    mobile?: { url?: string; alt?: string };
  };
  logo?: { url?: string; alt?: string };
  button_label?: string;
  button_link?: { url?: string } | string;
  primaryCta?: { label: string; href: string };
  secondaryCta?: { label: string; href: string };
  contentPosition?:
    | "left"
    | "center"
    | "right"
    | "bottom-left"
    | "bottom-right";
  overlayOpacity?: number;
  containerWidth?: "full" | "contained";
}

const {
  heading,
  tagline,
  image: prismicImage,
  logo: prismicLogo,
  button_label,
  button_link,
  primaryCta: directCta,
  secondaryCta,
  contentPosition: directPosition,
  overlayOpacity: directOverlay,
  containerWidth: directContainerWidth,
} = Astro.props;

const getUrl = (link: any): string => {
  if (!link) return "#";
  if (typeof link === "string") return link;
  return prismic.asLink(link, { linkResolver }) || "#";
};

const image = prismicImage
  ? { src: prismicImage.url || "", alt: prismicImage.alt || heading || "" }
  : { src: "", alt: "" };

const mobileImageSrc = prismicImage?.mobile?.url || "";

const logo = prismicLogo
  ? { src: prismicLogo.url || "", alt: prismicLogo.alt || "" }
  : null;

const primaryCta =
  directCta ||
  (button_label ? { label: button_label, href: getUrl(button_link) } : null);

// ============================================================
// ðŸŽ¨ DEVELOPER SETTINGS
// ============================================================
const contentPosition = directPosition || "bottom-right";
const overlayOpacity = directOverlay ?? 0;
const containerWidth = directContainerWidth || "full";
// ============================================================

// ============================================================
// Upcoming Events â€” fetched at build time, zero runtime cost
// ============================================================
const MAX_UPCOMING_EVENTS = 9;

let upcomingEvents: {
  title: string;
  image: string;
  imageAlt: string;
  url: string;
}[] = [];

try {
  const allEvents = await client.getAllByType("event", {
    orderings: [{ field: "my.event.date", direction: "asc" }],
  });

  const now = new Date();
  now.setHours(0, 0, 0, 0);

  upcomingEvents = allEvents
    .filter((e) => {
      if (!e.data.featured_image?.url) return false;
      if (e.data.date) {
        const start = new Date(e.data.date);
        start.setHours(0, 0, 0, 0);
        return start >= now;
      }
      return true;
    })
    .slice(0, MAX_UPCOMING_EVENTS)
    .map((e) => ({
      title: e.data.title || "Untitled",
      image: `${e.data.featured_image.url.split("?")[0]}?auto=format&q=80&w=600`,
      imageAlt: e.data.featured_image.alt || e.data.title || "",
      url: e.url || `/events/${e.uid}`,
    }));
} catch (e) {
  if (import.meta.env.DEV) {
    console.warn("HeroHomepage: Failed to fetch upcoming events.", e);
  }
}

// Desktop always needs exactly 3 columns filled.
// 1 event â†’ repeated 3Ã—, 2 events â†’ [A, B, A], 3 â†’ as-is.
// >3 â†’ pad to a multiple of 3 so desktop pages are always full.
let displayEvents = [...upcomingEvents];
if (displayEvents.length === 1) {
  displayEvents = [displayEvents[0], displayEvents[0], displayEvents[0]];
} else if (displayEvents.length === 2) {
  displayEvents = [displayEvents[0], displayEvents[1], displayEvents[0]];
} else if (displayEvents.length > 3) {
  while (displayEvents.length % 3 !== 0) {
    displayEvents.push(
      upcomingEvents[displayEvents.length % upcomingEvents.length],
    );
  }
}

const hasUpcomingEvents = upcomingEvents.length > 0;
const uniqueCount = upcomingEvents.length;
---

<section
  class:list={[
    "hero-homepage",
    `hero-homepage--${contentPosition}`,
    `hero-homepage--container-${containerWidth}`,
    hasUpcomingEvents && "hero-homepage--has-events",
  ]}
  style={`--overlay-opacity: ${overlayOpacity / 100}`}
>
  <div class="hero-homepage__bg">
    <picture>
      <source media="(max-width: 767px)" srcset={mobileImageSrc || image.src} />
      <img
        src={image.src}
        alt={image.alt}
        loading="eager"
        fetchpriority="high"
      />
    </picture>
  </div>

  <div class="hero-homepage__overlay"></div>

  {
    logo && (
      <div class="hero-homepage__logo">
        <img src={logo.src} alt={logo.alt} loading="eager" />
      </div>
    )
  }

  <div class="hero-homepage__container">
    <div class="hero-homepage__content">
      <h1 class="hero-homepage__heading">{heading}</h1>
      {tagline && <p class="hero-homepage__tagline">{tagline}</p>}
      {
        (primaryCta || secondaryCta) && (
          <div class="hero-homepage__actions">
            {primaryCta && (
              <a href={primaryCta.href} class="btn btn--primary-inverted">
                {primaryCta.label}
              </a>
            )}
            {secondaryCta && (
              <a href={secondaryCta.href} class="btn btn--secondary-inverted">
                {secondaryCta.label}
              </a>
            )}
          </div>
        )
      }
    </div>
  </div>

  {
    hasUpcomingEvents && (
      <button
        type="button"
        class="hero-homepage__events-toggle"
        data-events-toggle
        aria-expanded="false"
        aria-controls="hero-events-panel"
      >
        <span data-events-toggle-text>Upcoming Events</span>
      </button>
    )
  }

  {
    hasUpcomingEvents && (
      <div
        class="hero-homepage__events-panel"
        id="hero-events-panel"
        data-events-panel
        aria-hidden="true"
      >
        <div
          class="hero-homepage__events-track"
          data-events-track
          data-unique-count={String(uniqueCount)}
        >
          {displayEvents.map((event) => (
            <a href={event.url} class="hero-homepage__event-card">
              <img
                src={event.image}
                alt={event.imageAlt}
                loading="lazy"
                class="hero-homepage__event-image"
              />
            </a>
          ))}
        </div>
      </div>
    )
  }

  {
    hasUpcomingEvents && (
      <button type="button" class="hero-homepage__events-nav hero-homepage__events-nav--prev" data-events-prev aria-label="Previous">&#8249;</button>
    )
  }
  {
    hasUpcomingEvents && (
      <button type="button" class="hero-homepage__events-nav hero-homepage__events-nav--next" data-events-next aria-label="Next">&#8250;</button>
    )
  }
</section>

<script is:inline>
  (function () {
    var toggle = document.querySelector("[data-events-toggle]");
    var panel = document.querySelector("[data-events-panel]");
    var track = document.querySelector("[data-events-track]");
    var prevBtn = document.querySelector("[data-events-prev]");
    var nextBtn = document.querySelector("[data-events-next]");
    if (!toggle || !panel || !track) return;

    var isOpen = false;
    var timer = null;
    var currentPage = 0;
    var uniqueCount = parseInt(track.dataset.uniqueCount) || 0;
    var totalItems = track.children.length;

    function perPage() {
      return window.matchMedia("(min-width: 640px)").matches ? 3 : 1;
    }

    function totalPages() {
      var pp = perPage();
      return pp === 1 ? uniqueCount : Math.ceil(totalItems / pp);
    }

    function updateNav() {
      var show = isOpen && totalPages() > 1;
      if (prevBtn) prevBtn.style.display = show ? "flex" : "none";
      if (nextBtn) nextBtn.style.display = show ? "flex" : "none";
    }

    function goTo(page) {
      var pages = totalPages();
      if (pages <= 0) return;
      currentPage = ((page % pages) + pages) % pages;
      track.style.transform = "translateX(-" + currentPage * 100 + "%)";
    }

    function advance() {
      if (totalPages() <= 1) return;
      goTo(currentPage + 1);
    }

    function startTimer() {
      stopTimer();
      if (totalPages() > 1) {
        timer = setInterval(advance, 4000);
      }
    }

    function stopTimer() {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        goTo(currentPage - 1);
        startTimer();
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        goTo(currentPage + 1);
        startTimer();
      });
    }

    var touchX = 0;
    track.addEventListener("touchstart", function (e) {
      touchX = e.changedTouches[0].screenX;
    }, { passive: true });
    track.addEventListener("touchend", function (e) {
      var dx = touchX - e.changedTouches[0].screenX;
      if (Math.abs(dx) > 50) {
        goTo(currentPage + (dx > 0 ? 1 : -1));
        startTimer();
      }
    }, { passive: true });

    window.addEventListener("resize", function () {
      if (!isOpen) return;
      var pages = totalPages();
      if (currentPage >= pages) currentPage = Math.max(0, pages - 1);
      track.style.transform = "translateX(-" + currentPage * 100 + "%)";
      updateNav();
    });

    toggle.addEventListener("click", function () {
      var hero = toggle.closest(".hero-homepage");
      isOpen = !isOpen;
      hero.classList.toggle("hero-homepage--events-open", isOpen);
      toggle.setAttribute("aria-expanded", String(isOpen));
      panel.setAttribute("aria-hidden", String(!isOpen));
      toggle.querySelector("[data-events-toggle-text]").textContent = isOpen
        ? "Close"
        : "Upcoming Events";

      if (isOpen) {
        goTo(0);
        startTimer();
      } else {
        stopTimer();
      }
      updateNav();
    });
  })();
</script>

<style>
  /* ============================================================
     BASE STYLES
     ============================================================ */
  .hero-homepage {
    position: relative;
    display: flex;
    width: 100%;
    overflow: hidden;
    color: var(--color-bg);
    margin-top: var(--header-height, 96px);
  }

  /* ============================================================
     ASPECT RATIO â€” 4:5 mobile, 12:5 desktop
     3 Ã— (4:5) side-by-side with no gaps = 12:5
     ============================================================ */
  .hero-homepage--has-events {
    aspect-ratio: 4 / 5;
  }

  @media (min-width: 640px) {
    .hero-homepage--has-events {
      aspect-ratio: 12 / 5;
    }
  }

  .hero-homepage:not(.hero-homepage--has-events) {
    aspect-ratio: 4 / 5;
  }

  @media (min-width: 640px) {
    .hero-homepage:not(.hero-homepage--has-events) {
      aspect-ratio: 12 / 5;
    }
  }

  .hero-homepage__bg {
    position: absolute;
    inset: 0;
    z-index: 0;
  }

  .hero-homepage__bg picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .hero-homepage__bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hero-homepage__overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, var(--overlay-opacity, 0.4));
    z-index: 1;
  }

  /* ============================================================
     CENTERED LOGO
     ============================================================ */
  .hero-homepage__logo {
    position: absolute;
    top: 64px;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .hero-homepage__logo img {
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    pointer-events: auto;
  }

  @media (min-width: 768px) {
    .hero-homepage__logo {
      top: 80px;
    }
  }

  .hero-homepage__container {
    position: relative;
    z-index: 3;
    width: 100%;
    min-width: 0;
    margin-inline: auto;
    padding: var(--space-16) var(--gutter);
    display: flex;
    transition: opacity 0.3s ease;
  }

  @media (min-width: 768px) {
    .hero-homepage__container {
      padding: var(--space-24) var(--gutter-lg);
    }
  }

  .hero-homepage--events-open .hero-homepage__container {
    opacity: 0;
    pointer-events: none;
  }

  /* ============================================================
     CONTAINER WIDTH VARIANTS
     ============================================================ */
  .hero-homepage--container-full .hero-homepage__container {
    max-width: none;
  }

  .hero-homepage--container-contained .hero-homepage__container {
    max-width: var(--container-xl);
  }

  /* ============================================================
     POSITION VARIANTS
     ============================================================ */
  .hero-homepage--bottom-left .hero-homepage__container {
    align-items: flex-end;
    justify-content: flex-start;
  }

  .hero-homepage--left .hero-homepage__container {
    align-items: center;
    justify-content: flex-start;
  }

  .hero-homepage--center .hero-homepage__container {
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  .hero-homepage--center .hero-homepage__content {
    max-width: 60ch;
  }
  .hero-homepage--center .hero-homepage__actions {
    justify-content: center;
  }

  .hero-homepage--right .hero-homepage__container {
    align-items: center;
    justify-content: flex-end;
    text-align: right;
  }
  .hero-homepage--right .hero-homepage__actions {
    justify-content: flex-end;
  }

  .hero-homepage--bottom-right .hero-homepage__container {
    align-items: flex-end;
    justify-content: flex-end;
    text-align: right;
  }
  .hero-homepage--bottom-right .hero-homepage__actions {
    justify-content: flex-end;
  }

  /* ============================================================
     TYPOGRAPHY
     ============================================================ */
  .hero-homepage__heading {
    font-family: var(--font-serif);
    font-size: clamp(var(--text-4xl), 7vw, var(--text-6xl));
    font-weight: var(--font-medium);
    line-height: var(--leading-snug);
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    overflow-wrap: break-word;
  }

  .hero-homepage__tagline {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    opacity: 0.9;
    margin-bottom: var(--space-4);
    text-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
    max-width: 45ch;
  }

  @media (min-width: 768px) {
    .hero-homepage__tagline {
      font-size: var(--text-xl);
    }
  }

  /* ============================================================
     BUTTONS
     ============================================================ */
  .hero-homepage__actions {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
  }

  /* ============================================================
     EVENTS â€” TOGGLE BUTTON
     ============================================================ */
  .hero-homepage__events-toggle {
    position: absolute;
    bottom: var(--space-6);
    right: var(--gutter);
    z-index: 5;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    color: var(--color-bg);
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: var(--radius-full);
    padding: var(--space-2) var(--space-4);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  @media (min-width: 768px) {
    .hero-homepage__events-toggle {
      bottom: var(--space-8);
      right: var(--gutter-lg);
    }
  }

  .hero-homepage__events-toggle:hover {
    background: rgba(0, 0, 0, 0.6);
  }

  .hero-homepage--events-open .hero-homepage__events-toggle {
    background: rgba(0, 0, 0, 0.4);
  }

  /* ============================================================
     EVENTS â€” PANEL (edge-to-edge, no overlay/background)
     ============================================================ */
  .hero-homepage__events-panel {
    position: absolute;
    inset: 0;
    z-index: 4;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }

  .hero-homepage--events-open .hero-homepage__events-panel {
    opacity: 1;
    pointer-events: auto;
  }

  /* ============================================================
     EVENTS â€” TRACK (sliding strip, no gaps)
     ============================================================ */
  .hero-homepage__events-track {
    display: flex;
    height: 100%;
    transition: transform 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  /* ============================================================
     EVENTS â€” CARD (no radius, no gap, flush edge-to-edge)
     ============================================================ */
  .hero-homepage__event-card {
    flex: 0 0 100%;
    height: 100%;
    display: block;
  }

  @media (min-width: 640px) {
    .hero-homepage__event-card {
      flex: 0 0 calc(100% / 3);
    }
  }

  .hero-homepage__event-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity var(--transition-fast);
  }

  .hero-homepage__event-card:hover .hero-homepage__event-image {
    opacity: 0.8;
  }

  /* ============================================================
     EVENTS â€” NAV BUTTONS (prev/next)
     ============================================================ */
  .hero-homepage__events-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 6;
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    font-size: var(--text-lg);
    color: var(--color-bg);
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: var(--radius-full);
    cursor: pointer;
    padding: 0;
    transition: background var(--transition-fast), opacity var(--transition-fast);
    opacity: 0.7;
  }

  .hero-homepage__events-nav:hover {
    background: rgba(0, 0, 0, 0.5);
    opacity: 1;
  }

  .hero-homepage__events-nav--prev {
    left: var(--space-3);
  }

  .hero-homepage__events-nav--next {
    right: var(--space-3);
  }

  @media (min-width: 768px) {
    .hero-homepage__events-nav {
      width: 2.5rem;
      height: 2.5rem;
    }

    .hero-homepage__events-nav--prev {
      left: var(--space-6);
    }

    .hero-homepage__events-nav--next {
      right: var(--space-6);
    }
  }
</style>
