---
/**
 * ImageGalleryEditorial
 *
 * "NYC Skyline" gallery â€” equal-width columns, natural image heights,
 * bottom-aligned. Click opens lightbox for full image with title + credit.
 *
 * ============================================================
 * ðŸš€ DEV-CONTROLLED â€” change per project
 * ============================================================
 *
 * STEP 1: Grid columns (line ~70)
 *   - 3  â†’ Portfolio / general
 *   - 4  â†’ Thumbnails
 *   - 5  â†’ Dense editorial grid
 *   - 6  â†’ Book covers, archive
 *
 * STEP 2: Gap (line ~71â€“72)
 *   - "tight"   â†’ var(--space-2)
 *   - "default" â†’ var(--space-4)
 *   - "loose"   â†’ var(--space-6)
 *   Set rowGap and colGap independently
 *
 * ============================================================
 * ðŸ“ PRISMIC FIELDS â€” Slice (image_gallery_editorial)
 * ============================================================
 *   Non-repeatable zone (slice.primary):
 *   - heading (Key Text)
 *   - description (Rich Text)
 *   - background_colour (Select): main | secondary | accent
 *
 *   Repeatable zone (slice.items):
 *   - image (Image)
 *   - image_title (Key Text)    â€” shown in lightbox
 *   - image_credit (Key Text)   â€” shown in lightbox
 *   - image_link (Link)         â€” optional link
 */
import Section from "../Section.astro";
import Lightbox from "../Lightbox.astro";
import * as prismic from "@prismicio/client";
import { linkResolver } from "../../lib/prismic";

interface GalleryItem {
  image?: {
    url?: string;
    alt?: string;
    dimensions?: { width: number; height: number };
  };
  image_title?: string;
  image_credit?: string;
  image_link?: prismic.LinkField;
}

interface Props {
  heading?: string;
  description?: prismic.RichTextField;
  background_colour?: "main" | "secondary" | "accent";
  items?: GalleryItem[];
  slice?: any;
}

const {
  heading,
  description,
  background_colour = "main",
  items = [],
} = Astro.props;

// ============================================================
// ðŸ”’ DEV-CONTROLLED
// ============================================================
const columns: 3 | 4 | 5 | 6 = 5;
const rowGap: "tight" | "default" | "loose" = "loose";
const colGap: "tight" | "default" | "loose" = "tight";

// Background
const bgValue = String(background_colour || "main").toLowerCase();
const background =
  bgValue === "secondary" ? "alt" : bgValue === "accent" ? "accent" : "default";

// Rich text
const descriptionHtml =
  description && Array.isArray(description) && description.length > 0
    ? prismic.asHTML(description as prismic.RichTextField, { linkResolver })
    : "";

// Responsive srcset
const generateSrcset = (url: string) => {
  if (!url) return "";
  const baseUrl = url.split("?")[0];
  return `${baseUrl}?w=400&auto=format 400w, ${baseUrl}?w=600&auto=format 600w, ${baseUrl}?w=900&auto=format 900w`;
};

// Normalize items
const galleryItems = (items || [])
  .map((item: GalleryItem) => ({
    src: item.image?.url || "",
    alt: item.image?.alt || "",
    width: item.image?.dimensions?.width,
    height: item.image?.dimensions?.height,
    srcset: generateSrcset(item.image?.url || ""),
    title: item.image_title || "",
    credit: item.image_credit || "",
  }))
  .filter((img) => img.src);

// Lightbox items
const lightboxItems = galleryItems.map((img) => ({
  src: img.src,
  alt: img.alt,
  title: img.title,
  credit: img.credit,
}));

const lightboxId = `editorial-lb-${Math.random().toString(36).slice(2, 9)}`;
---

<Section spacing="default" background={background} container="wide">
  <div class="editorial-gallery">
    {/* Header */}
    {
      (heading || descriptionHtml) && (
        <div class="editorial-gallery__header">
          {heading && <h2 class="editorial-gallery__heading">{heading}</h2>}
          {descriptionHtml && (
            <div
              class="editorial-gallery__description"
              set:html={descriptionHtml}
            />
          )}
        </div>
      )
    }

    {/* Grid */}
    {
      galleryItems.length > 0 && (
        <div
          class:list={[
            "editorial-gallery__grid",
            `editorial-gallery__grid--${columns}-col`,
            `editorial-gallery__grid--row-gap-${rowGap}`,
            `editorial-gallery__grid--col-gap-${colGap}`,
          ]}
        >
          {galleryItems.map((image, i) => (
            <div
              class="editorial-gallery__item"
              data-lightbox-target={lightboxId}
              data-lightbox-index={i}
              role="button"
              tabindex="0"
              aria-label={`View ${image.alt || image.title || "image"}`}
            >
              <img
                src={image.src}
                srcset={image.srcset}
                sizes={
                  columns <= 3
                    ? `(min-width: 768px) ${Math.round(100 / columns)}vw, 100vw`
                    : `(min-width: 1024px) ${Math.round(100 / columns)}vw, (min-width: 768px) 33vw, 50vw`
                }
                alt={image.alt}
                width={image.width}
                height={image.height}
                loading="lazy"
                decoding="async"
                class="editorial-gallery__image"
              />
            </div>
          ))}
        </div>
      )
    }
  </div>
</Section>

<Lightbox items={lightboxItems} id={lightboxId} />

<style>
  .editorial-gallery {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
  }

  /* Header */
  .editorial-gallery__header {
    max-width: 60ch;
  }

  .editorial-gallery__heading {
    font-family: var(--font-serif);
    font-size: var(--text-4xl);
    line-height: var(--leading-snug);
    margin-bottom: var(--space-4);
  }

  .editorial-gallery__description {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-muted);
  }

  /* Grid â€” bottom-aligned (the NYC skyline effect) */
  .editorial-gallery__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    align-items: end;
  }

  /* Row gap variants */
  .editorial-gallery__grid--row-gap-tight {
    row-gap: var(--space-2);
  }
  .editorial-gallery__grid--row-gap-default {
    row-gap: var(--space-4);
  }
  .editorial-gallery__grid--row-gap-loose {
    row-gap: var(--space-24);
  }

  /* Col gap variants */
  .editorial-gallery__grid--col-gap-tight {
    column-gap: var(--space-2);
  }
  .editorial-gallery__grid--col-gap-default {
    column-gap: var(--space-4);
  }
  .editorial-gallery__grid--col-gap-loose {
    column-gap: var(--space-6);
  }

  /* Column variants */
  @media (min-width: 640px) {
    .editorial-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .editorial-gallery__grid--4-col {
      grid-template-columns: repeat(2, 1fr);
    }
    .editorial-gallery__grid--5-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .editorial-gallery__grid--6-col {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 768px) {
    .editorial-gallery__grid--4-col {
      grid-template-columns: repeat(4, 1fr);
    }
    .editorial-gallery__grid--5-col {
      grid-template-columns: repeat(4, 1fr);
    }
    .editorial-gallery__grid--6-col {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .editorial-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .editorial-gallery__grid--4-col {
      grid-template-columns: repeat(4, 1fr);
    }
    .editorial-gallery__grid--5-col {
      grid-template-columns: repeat(5, 1fr);
    }
    .editorial-gallery__grid--6-col {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* Gallery item */
  .editorial-gallery__item {
    margin: 0;
    overflow: hidden;
    cursor: pointer;
  }

  .editorial-gallery__item:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Natural height â€” no forced aspect ratio */
  .editorial-gallery__image {
    display: block;
    width: 100%;
    height: auto;
  }
</style>
