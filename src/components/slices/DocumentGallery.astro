---
/**
 * DocumentGallery
 *
 * A grid of downloadable documents (PDFs, images, etc.).
 * Each item is a coloured card with the document title displayed
 * prominently. Clicking opens/downloads the linked file.
 *
 * Items without a file link render as inert cards.
 *
 * ============================================================
 * ðŸš€ DEV-CONTROLLED â€” change per project
 * ============================================================
 *
 * STEP 1: Grid columns (line ~65)
 *   - 2  â†’ Fewer documents, larger cards
 *   - 3  â†’ Default, comfortable
 *   - 4  â†’ Dense listing
 *
 * STEP 2: Aspect ratio (line ~66)
 *   - "square"    â†’ 1/1
 *   - "landscape" â†’ 3/2
 *   - "portrait"  â†’ 2/3
 *
 * STEP 3: Gap (line ~67â€“68)
 *   - "tight"   â†’ var(--space-2)
 *   - "default" â†’ var(--space-4)
 *   - "loose"   â†’ var(--space-6)
 *
 * ============================================================
 * ðŸ“ PRISMIC FIELDS â€” Slice (document_gallery)
 * ============================================================
 *   Non-repeatable zone (slice.primary):
 *   - heading (Key Text)
 *   - description (Rich Text)
 *   - background_colour (Select): main | secondary | accent
 *
 *   Repeatable zone (slice.items):
 *   - document_title (Key Text)   â€” title shown on the card
 *   - document_file (Link/Media)  â€” link to PDF, image, etc.
 */
import Section from "../Section.astro";
import * as prismic from "@prismicio/client";
import { linkResolver } from "../../lib/prismic";

interface DocumentItem {
  document_title?: string;
  document_file?: prismic.LinkField;
}

interface Props {
  heading?: string;
  description?: prismic.RichTextField;
  background_colour?: "main" | "secondary" | "accent";
  items?: DocumentItem[];
  slice?: any;
}

const {
  heading,
  description,
  background_colour = "main",
  items = [],
} = Astro.props;

// ============================================================
// ðŸ”’ DEV-CONTROLLED
// ============================================================
const columns: 2 | 3 | 4 = 3;
const aspectRatio: "square" | "landscape" | "portrait" = "landscape";
const rowGap: "tight" | "default" | "loose" = "default";
const colGap: "tight" | "default" | "loose" = "default";

// Background
const bgValue = String(background_colour || "main").toLowerCase();
const background =
  bgValue === "secondary" ? "alt" : bgValue === "accent" ? "accent" : "default";

// Rich text
const descriptionHtml =
  description && Array.isArray(description) && description.length > 0
    ? prismic.asHTML(description as prismic.RichTextField, { linkResolver })
    : "";

// Normalise items
const docItems = (items || [])
  .map((item: DocumentItem) => {
    const url = item.document_file
      ? prismic.asLink(item.document_file, { linkResolver }) || ""
      : "";
    return {
      title: item.document_title || "Untitled",
      url,
    };
  })
  .filter((doc) => doc.title);

// File-type label helper
function getFileLabel(url: string): string {
  if (!url) return "Link";
  const ext = url.split("?")[0].split(".").pop()?.toLowerCase() || "";
  if (ext === "pdf") return "PDF";
  if (["jpg", "jpeg", "png", "gif", "webp", "svg"].includes(ext))
    return "Image";
  if (["doc", "docx"].includes(ext)) return "Word";
  if (["xls", "xlsx"].includes(ext)) return "Excel";
  return "File";
}
---

<Section spacing="compact" background={background} container="default">
  <div class="doc-gallery">
    {/* Header */}
    {
      (heading || descriptionHtml) && (
        <div class="doc-gallery__header">
          {heading && <h2 class="doc-gallery__heading">{heading}</h2>}
          {descriptionHtml && (
            <div class="doc-gallery__description" set:html={descriptionHtml} />
          )}
        </div>
      )
    }

    {/* Grid */}
    {
      docItems.length > 0 && (
        <div
          class:list={[
            "doc-gallery__grid",
            `doc-gallery__grid--${columns}-col`,
            `doc-gallery__grid--${aspectRatio}`,
            `doc-gallery__grid--row-gap-${rowGap}`,
            `doc-gallery__grid--col-gap-${colGap}`,
          ]}
        >
          {docItems.map((doc, i) => {
            const colorIndex = (i % 8) + 1;
            const fileLabel = getFileLabel(doc.url);
            const Tag = doc.url ? "a" : "div";
            const linkProps = doc.url
              ? { href: doc.url, target: "_blank", rel: "noopener noreferrer" }
              : {};

            return (
              <Tag
                class="doc-gallery__card"
                data-color={colorIndex}
                {...linkProps}
              >
                <span class="doc-gallery__badge">{fileLabel}</span>
                <span class="doc-gallery__title">{doc.title}</span>
              </Tag>
            );
          })}
        </div>
      )
    }
  </div>
</Section>

<style>
  .doc-gallery {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);

    /* Colour palette â€” 8 rotating colours */
    --doc-color-1: #f97b5e; /* coral */
    --doc-color-2: #c4b5e0; /* lavender */
    --doc-color-3: #7ec8e3; /* sky */
    --doc-color-4: #f5a623; /* amber */
    --doc-color-5: #a8d5ba; /* sage */
    --doc-color-6: #f2b5c6; /* pink */
    --doc-color-7: #f5cf3c; /* gold */
    --doc-color-8: #c4ad91; /* tan */
  }

  /* Header */
  .doc-gallery__header {
    max-width: 100%;
  }

  @media (min-width: 768px) {
    .doc-gallery__header {
      max-width: 50%;
    }
  }

  .doc-gallery__heading {
    font-family: var(--font-serif);
    font-size: var(--text-4xl);
    line-height: var(--leading-snug);
    margin-bottom: var(--space-4);
  }

  .doc-gallery__description {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-muted);
  }

  /* Grid */
  .doc-gallery__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
  }

  /* Row gap variants */
  .doc-gallery__grid--row-gap-tight {
    row-gap: var(--space-2);
  }
  .doc-gallery__grid--row-gap-default {
    row-gap: var(--space-4);
  }
  .doc-gallery__grid--row-gap-loose {
    row-gap: var(--space-6);
  }

  /* Col gap variants */
  .doc-gallery__grid--col-gap-tight {
    column-gap: var(--space-2);
  }
  .doc-gallery__grid--col-gap-default {
    column-gap: var(--space-4);
  }
  .doc-gallery__grid--col-gap-loose {
    column-gap: var(--space-6);
  }

  /* Column variants */
  @media (min-width: 768px) {
    .doc-gallery__grid--2-col {
      grid-template-columns: repeat(2, 1fr);
    }
    .doc-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .doc-gallery__grid--4-col {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .doc-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .doc-gallery__grid--4-col {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* ============================================================
     CARD â€” coloured panel with title
     ============================================================ */
  .doc-gallery__card {
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: var(--space-6);
    text-decoration: none;
    color: inherit;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
  }

  /* Aspect ratios */
  .doc-gallery__grid--square .doc-gallery__card {
    aspect-ratio: 1 / 1;
  }
  .doc-gallery__grid--landscape .doc-gallery__card {
    aspect-ratio: 3 / 2;
  }
  .doc-gallery__grid--portrait .doc-gallery__card {
    aspect-ratio: 2 / 3;
  }

  a.doc-gallery__card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
  }

  a.doc-gallery__card:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Background colours via data-attribute */
  .doc-gallery__card[data-color="1"] {
    background-color: var(--doc-color-1);
  }
  .doc-gallery__card[data-color="2"] {
    background-color: var(--doc-color-2);
  }
  .doc-gallery__card[data-color="3"] {
    background-color: var(--doc-color-3);
  }
  .doc-gallery__card[data-color="4"] {
    background-color: var(--doc-color-4);
  }
  .doc-gallery__card[data-color="5"] {
    background-color: var(--doc-color-5);
  }
  .doc-gallery__card[data-color="6"] {
    background-color: var(--doc-color-6);
  }
  .doc-gallery__card[data-color="7"] {
    background-color: var(--doc-color-7);
  }
  .doc-gallery__card[data-color="8"] {
    background-color: var(--doc-color-8);
  }

  /* File-type badge â€” small label in top-left */
  .doc-gallery__badge {
    position: absolute;
    top: var(--space-4);
    left: var(--space-4);
    font-size: var(--text-xs, 0.75rem);
    font-weight: var(--font-semibold, 600);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    background: rgba(255, 255, 255, 0.35);
    color: rgba(0, 0, 0, 0.6);
    padding: 0.15em 0.6em;
    border-radius: 3px;
    line-height: 1.5;
    user-select: none;
  }

  /* Title â€” bottom of card, prominent */
  .doc-gallery__title {
    font-family: var(--font-serif);
    font-size: clamp(1.1rem, 2.5vw, 1.5rem);
    font-weight: var(--font-bold, 700);
    line-height: var(--leading-snug, 1.3);
    color: rgba(0, 0, 0, 0.7);
    word-break: break-word;
  }
</style>
