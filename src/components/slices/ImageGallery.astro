---
/**
 * ImageGallery
 *
 * Traditional grid gallery â€” uniform columns with fixed aspect ratio.
 * Click opens lightbox showing title, counter, and credit.
 * Items without images show a coloured placeholder panel with the
 * first letter of the title centred in a muted tone.
 *
 * ============================================================
 * ðŸš€ DEV-CONTROLLED â€” change per project
 * ============================================================
 *
 * STEP 1: Grid columns (line ~78)
 *   - 2  â†’ Editorial pairs, case studies
 *   - 3  â†’ Portfolio, general gallery
 *   - 4  â†’ Thumbnails
 *   - 6  â†’ Logo/icon grids, dense archive
 *
 * STEP 2: Aspect ratio (line ~79)
 *   - "square"    â†’ 1/1 (clean editorial grid)
 *   - "landscape" â†’ 3/2 (wider, good for photos)
 *   - "portrait"  â†’ 2/3 (tall, fashion/people)
 *
 * STEP 3: Gap (line ~80â€“81)
 *   - "tight"   â†’ var(--space-2)
 *   - "default" â†’ var(--space-4)
 *   - "loose"   â†’ var(--space-6)
 *   Set rowGap and colGap independently
 *
 * ============================================================
 * ðŸ“ PRISMIC FIELDS â€” Slice (image_gallery)
 * ============================================================
 *   Non-repeatable zone (slice.primary):
 *   - heading (Key Text)
 *   - description (Rich Text)
 *   - background_colour (Select): main | secondary | accent
 *
 *   Repeatable zone (slice.items):
 *   - image (Image)
 *   - image_title (Key Text)    â€” shown in lightbox
 *   - image_credit (Key Text)   â€” shown in lightbox
 *   - image_link (Link)         â€” optional navigation link
 */
import Section from "../Section.astro";
import Lightbox from "../Lightbox.astro";
import * as prismic from "@prismicio/client";
import { linkResolver } from "../../lib/prismic";

interface GalleryItem {
  image?: {
    url?: string;
    alt?: string;
    dimensions?: { width: number; height: number };
  };
  image_title?: string;
  image_credit?: string;
  image_link?: prismic.LinkField;
}

interface Props {
  heading?: string;
  description?: prismic.RichTextField;
  background_colour?: "main" | "secondary" | "accent";
  items?: GalleryItem[];
  slice?: any;
}

const {
  heading,
  description,
  background_colour = "main",
  items = [],
} = Astro.props;

// ============================================================
// ðŸ”’ DEV-CONTROLLED
// ============================================================
const columns: 2 | 3 | 4 | 6 = 3;
const aspectRatio: "square" | "landscape" | "portrait" = "landscape";
const rowGap: "tight" | "default" | "loose" = "default";
const colGap: "tight" | "default" | "loose" = "default";

// Background
const bgValue = String(background_colour || "main").toLowerCase();
const background =
  bgValue === "secondary" ? "alt" : bgValue === "accent" ? "accent" : "default";

// Rich text
const descriptionHtml =
  description && Array.isArray(description) && description.length > 0
    ? prismic.asHTML(description as prismic.RichTextField, { linkResolver })
    : "";

// Responsive srcset
const generateSrcset = (url: string) => {
  if (!url) return "";
  const baseUrl = url.split("?")[0];
  return `${baseUrl}?w=600&auto=format 600w, ${baseUrl}?w=900&auto=format 900w, ${baseUrl}?w=1200&auto=format 1200w`;
};

// Normalize items â€” keep items with image OR title
const galleryItems = (items || [])
  .map((item: GalleryItem) => ({
    src: item.image?.url || "",
    alt: item.image?.alt || "",
    width: item.image?.dimensions?.width,
    height: item.image?.dimensions?.height,
    srcset: generateSrcset(item.image?.url || ""),
    title: item.image_title || "",
    credit: item.image_credit || "",
    hasImage: Boolean(item.image?.url),
  }))
  .filter((img) => img.src || img.title);

// Lightbox items â€” only real images
const lightboxItems = galleryItems
  .filter((img) => img.hasImage)
  .map((img) => ({
    src: img.src,
    alt: img.alt,
    title: img.title,
    credit: img.credit,
  }));

// Build a map from gallery index â†’ lightbox index (only for items with images)
let lbIndex = 0;
const lightboxIndexMap = galleryItems.map((img) => {
  if (img.hasImage) {
    return lbIndex++;
  }
  return -1;
});

const lightboxId = `gallery-lb-${Math.random().toString(36).slice(2, 9)}`;
---

<Section spacing="compact" background={background} container="wide">
  <div class="image-gallery">
    {/* Header */}
    {
      (heading || descriptionHtml) && (
        <div class="image-gallery__header">
          {heading && <h2 class="image-gallery__heading">{heading}</h2>}
          {descriptionHtml && (
            <div
              class="image-gallery__description"
              set:html={descriptionHtml}
            />
          )}
        </div>
      )
    }

    {/* Grid */}
    {
      galleryItems.length > 0 && (
        <div
          class:list={[
            "image-gallery__grid",
            `image-gallery__grid--${columns}-col`,
            `image-gallery__grid--${aspectRatio}`,
            `image-gallery__grid--row-gap-${rowGap}`,
            `image-gallery__grid--col-gap-${colGap}`,
          ]}
        >
          {galleryItems.map((image, i) => {
            const colorIndex = (i % 8) + 1;
            const initial = (image.title || image.alt || "?")
              .charAt(0)
              .toUpperCase();

            return image.hasImage ? (
              <div
                class="image-gallery__item"
                data-lightbox-target={lightboxId}
                data-lightbox-index={lightboxIndexMap[i]}
                role="button"
                tabindex="0"
                aria-label={`View ${image.alt || image.title || "image"}`}
              >
                <img
                  src={image.src}
                  srcset={image.srcset}
                  sizes={
                    columns === 2
                      ? "(min-width: 768px) 50vw, 100vw"
                      : columns === 4
                        ? "(min-width: 1024px) 25vw, (min-width: 768px) 50vw, 100vw"
                        : columns === 6
                          ? "(min-width: 1024px) 16.67vw, (min-width: 768px) 33vw, 50vw"
                          : "(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
                  }
                  alt={image.alt}
                  width={image.width}
                  height={image.height}
                  loading="lazy"
                  decoding="async"
                  class="image-gallery__image"
                />
              </div>
            ) : (
              <div
                class="image-gallery__item image-gallery__placeholder"
                data-color={colorIndex}
                aria-label={image.title || "Gallery item"}
              >
                <span class="image-gallery__initial">{initial}</span>
              </div>
            );
          })}
        </div>
      )
    }
  </div>
</Section>

<Lightbox items={lightboxItems} id={lightboxId} />

<style>
  .image-gallery {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);

    /* Placeholder colour palette â€” matches Features */
    --gallery-color-1: #f97b5e; /* coral */
    --gallery-color-2: #c4b5e0; /* lavender */
    --gallery-color-3: #7ec8e3; /* sky */
    --gallery-color-4: #f5a623; /* amber */
    --gallery-color-5: #a8d5ba; /* sage */
    --gallery-color-6: #f2b5c6; /* pink */
    --gallery-color-7: #f5cf3c; /* gold */
    --gallery-color-8: #c4ad91; /* tan */
  }

  /* Header */
  .image-gallery__header {
    max-width: 100%;
  }

  @media (min-width: 768px) {
    .image-gallery__header {
      max-width: 50%;
    }
  }

  .image-gallery__heading {
    font-family: var(--font-serif);
    font-size: var(--text-4xl);
    line-height: var(--leading-snug);
    margin-bottom: var(--space-4);
  }

  .image-gallery__description {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-muted);
  }

  /* Grid */
  .image-gallery__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
  }

  /* Row gap variants */
  .image-gallery__grid--row-gap-tight {
    row-gap: var(--space-2);
  }
  .image-gallery__grid--row-gap-default {
    row-gap: var(--space-4);
  }
  .image-gallery__grid--row-gap-loose {
    row-gap: var(--space-6);
  }

  /* Col gap variants */
  .image-gallery__grid--col-gap-tight {
    column-gap: var(--space-2);
  }
  .image-gallery__grid--col-gap-default {
    column-gap: var(--space-4);
  }
  .image-gallery__grid--col-gap-loose {
    column-gap: var(--space-6);
  }

  /* Column variants */
  @media (min-width: 768px) {
    .image-gallery__grid--2-col {
      grid-template-columns: repeat(2, 1fr);
    }
    .image-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .image-gallery__grid--4-col {
      grid-template-columns: repeat(2, 1fr);
    }
    .image-gallery__grid--6-col {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .image-gallery__grid--3-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .image-gallery__grid--4-col {
      grid-template-columns: repeat(4, 1fr);
    }
    .image-gallery__grid--6-col {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* Gallery item */
  .image-gallery__item {
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .image-gallery__item:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Aspect ratios */
  .image-gallery__grid--square .image-gallery__item {
    aspect-ratio: 1 / 1;
  }
  .image-gallery__grid--landscape .image-gallery__item {
    aspect-ratio: 3 / 2;
  }
  .image-gallery__grid--portrait .image-gallery__item {
    aspect-ratio: 2 / 3;
  }

  .image-gallery__image {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .image-gallery__item:hover .image-gallery__image {
    transform: scale(1.03);
  }

  /* ============================================================
     PLACEHOLDER PANELS â€” coloured fallback when no image
     ============================================================ */
  .image-gallery__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: default;
  }

  .image-gallery__placeholder[data-color="1"] {
    background-color: var(--gallery-color-1);
  }
  .image-gallery__placeholder[data-color="2"] {
    background-color: var(--gallery-color-2);
  }
  .image-gallery__placeholder[data-color="3"] {
    background-color: var(--gallery-color-3);
  }
  .image-gallery__placeholder[data-color="4"] {
    background-color: var(--gallery-color-4);
  }
  .image-gallery__placeholder[data-color="5"] {
    background-color: var(--gallery-color-5);
  }
  .image-gallery__placeholder[data-color="6"] {
    background-color: var(--gallery-color-6);
  }
  .image-gallery__placeholder[data-color="7"] {
    background-color: var(--gallery-color-7);
  }
  .image-gallery__placeholder[data-color="8"] {
    background-color: var(--gallery-color-8);
  }

  .image-gallery__initial {
    font-family: var(--font-serif);
    font-size: clamp(3rem, 8vw, 6rem);
    font-weight: var(--font-bold);
    line-height: 1;
    color: var(--color-text-muted);
    opacity: 0.35;
    user-select: none;
  }
</style>
