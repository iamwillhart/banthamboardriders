---
/**
 * Dynamic Page
 *
 * Catches all Prismic "page" documents (about, contact, services, etc.)
 * URL is determined by the document's UID in Prismic.
 */
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SliceZone from "../components/SliceZone.astro";
import { client, getSettings } from "../lib/prismic";

// Generate static paths for all pages
export async function getStaticPaths() {
  const pages = await client.getAllByType("page");

  // Filter out pages with null/undefined UIDs (incomplete drafts)
  return pages
    .filter((page) => page.uid)
    .map((page) => ({
      params: { uid: page.uid },
      props: { page },
    }));
}

const { page } = Astro.props;
const slices = page.data.body || [];
const settings = await getSettings();

const title = page.data.meta_title || page.data.title || "Page";
const description = page.data.meta_description || "";
// Social image: page-specific → settings default → none
const image =
  page.data.meta_image?.url || settings?.data?.default_og_image?.url || "";

// ============================================================
// Header config — auto-derived from first slice
// ============================================================
// Default: transparent header for inner pages (sits over the hero)
// Override: Prismic `header_style` field can force "Solid" if needed
const headerVariant: "transparent" | "solid" =
  page.data.header_style === "Solid" ? "solid" : "transparent";

// When transparent, match text color to the hero behind it
let headerTextColor: "light" | "dark" = "light";

const firstSlice = slices[0];
if (
  headerVariant === "transparent" &&
  firstSlice?.slice_type === "hero_secondary"
) {
  const heroBg = firstSlice.primary?.background_colour || "accent";
  // Light backgrounds (main, secondary) → dark header text
  // Colored backgrounds (accent) → light header text
  headerTextColor = ["main", "secondary"].includes(heroBg) ? "dark" : "light";
}
// HeroHomepage (photo bg) → default "light" text is correct

// Scroll behavior follows variant (dev decision, not client concern)
const headerScrollBehavior =
  headerVariant === "solid" ? "none" : "solid-on-scroll";
---

<Layout title={title} description={description} image={image}>
  <Header
    variant={headerVariant}
    scrollBehavior={headerScrollBehavior}
    textColor={headerTextColor}
  />
  <main>
    <SliceZone slices={slices} />
  </main>
  <Footer />
</Layout>
