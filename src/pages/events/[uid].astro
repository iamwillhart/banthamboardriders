---
/**
 * Event Detail Page
 *
 * Displays a single Prismic "event" document.
 * Shows event header with date/time, location, category,
 * booking link, then the slice zone body.
 *
 * Hero uses a split layout: text left, featured image (4:5) right.
 */
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import SliceZone from "../../components/SliceZone.astro";
import Section from "../../components/Section.astro";
import { client, getSettings } from "../../lib/prismic";
import * as prismic from "@prismicio/client";
import { linkResolver } from "../../lib/prismic";

// Generate static paths for all events
export async function getStaticPaths() {
  const events = await client.getAllByType("event");

  return events
    .filter((event) => event.uid)
    .map((event) => ({
      params: { uid: event.uid },
      props: { event },
    }));
}

const { event } = Astro.props;
const slices = event.data.body || [];
const settings = await getSettings();

const title = event.data.meta_title || event.data.title || "Event";
const description = event.data.meta_description || event.data.excerpt || "";
const image =
  event.data.meta_image?.url || settings?.data?.default_og_image?.url || "";

// ============================================================
// Date formatting helpers
// ============================================================
const startDate = event.data.start_date_time
  ? new Date(event.data.start_date_time)
  : null;
const endDate = event.data.end_date_time
  ? new Date(event.data.end_date_time)
  : null;

function formatDate(date: Date): string {
  return date.toLocaleDateString("en-GB", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

function formatTime(date: Date): string {
  return date.toLocaleTimeString("en-GB", {
    hour: "2-digit",
    minute: "2-digit",
  });
}

// Build display strings
let dateDisplay = "";
let timeDisplay = "";

if (startDate) {
  const startDay = startDate.toDateString();
  const endDay = endDate ? endDate.toDateString() : null;

  if (endDate && endDay !== startDay) {
    // Multi-day event
    dateDisplay = `${formatDate(startDate)} – ${formatDate(endDate)}`;
    timeDisplay = `${formatTime(startDate)} – ${formatTime(endDate)}`;
  } else {
    // Single day event
    dateDisplay = formatDate(startDate);
    timeDisplay = formatTime(startDate);
    if (endDate) {
      timeDisplay = `${formatTime(startDate)} – ${formatTime(endDate)}`;
    }
  }
}

// Booking link
const bookingUrl = event.data.booking_link
  ? prismic.asLink(event.data.booking_link, { linkResolver })
  : null;

const hasFeaturedImage = !!event.data.featured_image?.url;

// Determine the last slice's background color
const lastSlice = slices.length > 0 ? slices[slices.length - 1] : null;
const lastSliceBgRaw = String(
  lastSlice?.primary?.background_colour || "main",
).toLowerCase();
const lastSliceBg =
  lastSliceBgRaw === "secondary"
    ? "alt"
    : lastSliceBgRaw === "accent"
      ? "accent"
      : "default";
---

<Layout title={title} description={description} image={image}>
  <Header variant="solid" scrollBehavior="none" />
  <main>
    {/* Event hero — split layout when image present */}
    <Section
      spacing="hero"
      container="none"
      class={`event-hero${hasFeaturedImage ? " event-hero--has-image" : ""}`}
    >
      <div class="event-hero__inner">
        {/* Text column */}
        <div class="event-hero__content">
          {
            event.data.category && (
              <span class="event-header__category">{event.data.category}</span>
            )
          }
          <h1 class="heading-1">{event.data.title}</h1>
          {
            event.data.excerpt && (
              <p class="text-body-lg text-muted">{event.data.excerpt}</p>
            )
          }

          <div class="event-meta">
            <div class="event-meta__item">
              <span class="text-label">Date</span>
              <span class="text-body">
                {dateDisplay || "To be confirmed"}
              </span>
            </div>
            {
              timeDisplay && (
                <div class="event-meta__item">
                  <span class="text-label">Time</span>
                  <span class="text-body">{timeDisplay}</span>
                </div>
              )
            }
            {
              event.data.location && (
                <div class="event-meta__item">
                  <span class="text-label">Location</span>
                  <span class="text-body">{event.data.location}</span>
                </div>
              )
            }
          </div>

          {
            bookingUrl && (
              <div class="event-header__actions">
                <a
                  href={bookingUrl}
                  class="btn btn--primary"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Book Now
                </a>
              </div>
            )
          }
        </div>

        {/* Image column */}
        {
          hasFeaturedImage && (
            <div class="event-hero__image-col">
              <img
                src={`${event.data.featured_image.url.split("?")[0]}?auto=format&q=80&w=800`}
                alt={event.data.featured_image.alt || ""}
                width={event.data.featured_image.dimensions?.width}
                height={event.data.featured_image.dimensions?.height}
                class="event-hero__image"
                loading="eager"
                decoding="async"
              />
            </div>
          )
        }
      </div>
    </Section>

    <SliceZone slices={slices} />

    {/* Back link — inherits last slice's background */}
    <Section spacing="compact" background={lastSliceBg} container="wide">
      <div style="text-align: center;">
        <a href="/events" class="back-link text-label">← All Events</a>
      </div>
    </Section>
  </main>
  <Footer />
</Layout>

<style>
  /* ============================================================
     Hero section — custom inline padding for edge-bleed image
     :global() needed because .event-hero is on the Section wrapper,
     which is rendered in Section.astro's template, not this page's.
     ============================================================ */
  :global(.event-hero) {
    padding-inline: var(--gutter) 0;
  }

  @media (min-width: 768px) {
    :global(.event-hero) {
      padding-inline: var(--gutter-lg) 0;
      padding-block: 0;
    }
  }

  /* ============================================================
     Inner grid — stacks on mobile, side-by-side on desktop
     :global() on the parent since it's the Section wrapper
     ============================================================ */
  .event-hero__inner {
    margin-inline: auto;
  }

  @media (min-width: 768px) {
    :global(.event-hero--has-image) .event-hero__inner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-12);
      align-items: center;
    }
  }

  @media (min-width: 1024px) {
    :global(.event-hero--has-image) .event-hero__inner {
      gap: var(--space-16);
    }
  }

  /* ============================================================
     Text column
     ============================================================ */
  .event-hero__content {
    max-width: var(--container-md);
  }

  @media (min-width: 768px) {
    :global(.event-hero--has-image) .event-hero__content {
      max-width: none;
    }
  }

  .event-header__category {
    display: inline-block;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    color: var(--color-accent);
    margin-bottom: var(--space-2);
  }

  .heading-1 {
    font-weight: var(--font-bold);
  }

  .event-hero__content .heading-1 {
    margin-top: var(--space-2);
  }

  .event-hero__content .text-body-lg {
    margin-top: var(--space-4);
  }

  .event-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-8);
    margin-top: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-text-subtle);
  }

  .event-meta__item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .event-header__actions {
    margin-top: var(--space-8);
  }

  /* ============================================================
     Image column
     ============================================================ */
  .event-hero__image-col {
    margin-top: var(--space-10);
  }

  @media (min-width: 768px) {
    .event-hero__image-col {
      margin-top: 0;
    }
  }

  .event-hero__image {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 5;
    object-fit: cover;
    display: block;
    border-radius: none;
  }

  /* ============================================================
     Back link
     ============================================================ */
  .back-link {
    display: inline-block;
    transition: opacity var(--transition-fast);
    margin-bottom: var(--space-20);
    margin-right: var(--space-12);
  }

  .back-link:hover {
    opacity: 0.6;
  }
</style>
